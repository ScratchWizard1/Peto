name: Build frontend

on:
  push:
    branches: [ "master" ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Build frontend
        run: npm run build

      - name: Fix Vite manifest location
        run: |
          if [ -f public/build/.vite/manifest.json ]; then
            mv public/build/.vite/manifest.json public/build/manifest.json
            rm -rf public/build/.vite
          fi

      # ðŸ”’ Vytvor deploy archÃ­v (bez git, node_modules, env)
      - name: Create deploy archive
        run: |
          zip -r deploy.zip . \
            -x ".git/*" \
            -x "node_modules/*" \
            -x ".env" \
            -x "storage/logs/*" \
            -x "storage/framework/*"

      # ðŸš€ PoÅ¡li ZIP na server (webhook)
      - name: Send deploy to server
        env:
          DEPLOY_SECRET: ${{ secrets.DEPLOY_SECRET }}
        run: |
          SIGNATURE=$(echo -n "$(cat deploy.zip)" | openssl dgst -sha256 -hmac "$DEPLOY_SECRET" | sed 's/^.* //')
          curl -X POST https://bezek.ostrovskeho.eu/Blog/deploy.php \
            -H "X-Hub-Signature-256: sha256=$SIGNATURE" \
            --data-binary @deploy.zip